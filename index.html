<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الصفحة الرئيسية</title>
<style>
body {
  margin:0; padding-top:60px; min-height:100vh;
  font-family:'Tahoma', sans-serif; color:#fff; text-align:center;
  display:flex; flex-direction:column; align-items:center;
  background: linear-gradient(-45deg, #0f2027, #203a43, #2c5364, #0f2027);
  background-size:400% 400%; animation: gradientMove 12s ease infinite;
}
@keyframes gradientMove {0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
h1{ font-size:2.5rem; margin-bottom:20px; text-shadow:0 0 15px #00e6ff,0 0 30px #00e6ff; }

/* الشريط العلوي */
#topBar{
  position:fixed; top:0; left:0; width:100%; height:50px;
  background: rgba(0,0,0,0.7); display:flex; justify-content:flex-end; align-items:center;
  padding:0 20px; z-index:100; box-shadow:0 2px 10px rgba(0,0,0,0.5);
}
#userMenu{position:relative;}
#userBtn{background:none; border:none; color:#00e6ff; cursor:pointer; font-size:1rem;}
#userBtn:hover{text-decoration:underline;}
#dropdown{
  display:none; position:absolute; right:0; top:100%;
  background:#111; border:1px solid #00e6ff; border-radius:5px; min-width:150px;
}
#dropdown a{display:block; padding:8px 12px; color:#00e6ff; text-decoration:none;}
#dropdown a:hover{background:#00e6ff; color:#000;}

/* الفيديوهات */
.video-container{width:80%; max-width:800px; margin:20px 0; position:relative;}
.video-footer{margin-top:5px; display:flex; align-items:center; justify-content:center; gap:10px;}
.analysis-btn{padding:5px 10px; border-radius:5px; border:none; cursor:pointer; background:#00e6ff; color:#000;}
.modal{display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:200;}
.modal-content{background:#111; padding:20px; border-radius:10px; position:relative; min-width:300px;}
.close-btn{position:absolute; top:10px; right:10px; background:#ff4d4d; border:none; color:#fff; padding:5px 10px; cursor:pointer; border-radius:5px;}
#filterContainer{margin:10px;}
</style>
</head>
<body>

<div id="topBar">
  <div style="margin-right:auto; display:flex; align-items:center; gap:5px;">
    <span style="color:gold; font-weight:bold;">$</span>
    <span id="userAmount">0</span>
    <span>SR</span>
  </div>
  <div id="userMenu">
    <button id="userBtn">اسم المستخدم ▼</button>
    <div id="dropdown">
      <a href="user-info.html">معلومات المستخدم</a>
      <a href="#" id="logoutLink">تسجيل الخروج</a>
    </div>
  </div>
</div>

<h1 id="welcome">مرحبا بك!</h1>

<!-- تصفية الفيديوهات -->
<div id="filterContainer">
  <label><input type="checkbox" id="interestedFilter"> عرض المهتم فقط</label>
</div>

<!-- فيديوهات -->
<div class="video-container" data-id="-ZqrbdUtIGE">
  <div id="player--ZqrbdUtIGE"></div>
  <div class="video-footer">
    <label>مهتم: <input type="checkbox" class="interested-checkbox"></label>
    <button class="analysis-btn">عرض التحليل</button>
  </div>
</div>

<div class="video-container" data-id="dQw4w9WgXcQ">
  <div id="player-dQw4w9WgXcQ"></div>
  <div class="video-footer">
    <label>مهتم: <input type="checkbox" class="interested-checkbox"></label>
    <button class="analysis-btn">عرض التحليل</button>
  </div>
</div>

<!-- Modal للتحليل -->
<div id="modal" class="modal">
  <div class="modal-content">
    <button class="close-btn">اغلاق</button>
    <canvas id="analysisChart" width="400" height="300"></canvas>
  </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDUW9M48CLaSNKbs-zrpuVl2Tu9EOqLUlA",
  authDomain: "new-z-o.firebaseapp.com",
  projectId: "new-z-o",
  storageBucket: "new-z-o.firebasestorage.app",
  messagingSenderId: "692467470055",
  appId: "1:692467470055:web:3b4f4130b09f2044de9c42",
  measurementId: "G-M8KNYMSY3T"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
const welcome = document.getElementById('welcome');
const userBtn = document.getElementById('userBtn');
const dropdown = document.getElementById('dropdown');
const logoutLink = document.getElementById('logoutLink');
const userAmount = document.getElementById('userAmount');

onAuthStateChanged(auth, async (user) => {
  if (!user) window.location.href="login.html";
  else{
    currentUser = user;
    const displayName = user.displayName || user.email;
    userBtn.textContent = displayName + ' ▼';
    welcome.textContent = `مرحبا بك، ${displayName}!`;

    // جلب المبلغ من Firestore
    const userDoc = await getDoc(doc(db,"users",user.uid));
    if(userDoc.exists()){
      userAmount.textContent = userDoc.data().amount || 0;
    }
  }
});

userBtn.addEventListener('click',()=>{dropdown.style.display = dropdown.style.display==='block'?'none':'block';});
logoutLink.addEventListener('click', async ()=>{
  await signOut(auth);
  window.location.href="login.html";
});

// YouTube
const players = {};
function onYouTubeIframeAPIReady(){
  const videoDivs = document.querySelectorAll('.video-container');
  videoDivs.forEach(async div=>{
    const videoId = div.dataset.id;
    players[videoId] = new YT.Player(`player-${videoId}`,{
      height:'360', width:'640', videoId:videoId,
      playerVars:{autoplay:0,controls:1},
      events:{'onStateChange':(event)=>onPlayerStateChange(event,videoId)}
    });

    // جلب بيانات الفيديو
    const videoDocRef = doc(db,"videos",videoId);
    const videoSnap = await getDoc(videoDocRef);
    let videoData = videoSnap.exists()? videoSnap.data(): {views:0, interestedUsers:[], ageGroups:{"15-24":0,"25-30":0,"31-40":0,"40+":0}};

    // ضبط checkbox
    const checkBox = div.querySelector('.interested-checkbox');
    checkBox.checked = videoData.interestedUsers.includes(currentUser.uid);
    checkBox.addEventListener('change', async ()=>{
      if(checkBox.checked && !videoData.interestedUsers.includes(currentUser.uid)){
        videoData.interestedUsers.push(currentUser.uid);
      } else if(!checkBox.checked){
        videoData.interestedUsers = videoData.interestedUsers.filter(uid=>uid!==currentUser.uid);
      }
      await setDoc(videoDocRef, videoData, {merge:true});
    });

    // عرض التحليل
    const analysisBtn = div.querySelector('.analysis-btn');
    analysisBtn.addEventListener('click', ()=>{
      showAnalysis(videoData);
    });
  });
}

// عند انتهاء الفيديو
async function onPlayerStateChange(event, videoId){
  if(!currentUser) return;
  if(event.data===YT.PlayerState.ENDED){
    const userDocRef = doc(db,"users",currentUser.uid);
    const userSnap = await getDoc(userDocRef);
    const videoDocRef = doc(db,"videos",videoId);
    const videoSnap = await getDoc(videoDocRef);
    let userData = userSnap.exists()? userSnap.data(): {};
    let videoData = videoSnap.exists()? videoSnap.data(): {views:0,interestedUsers:[],ageGroups:{"15-24":0,"25-30":0,"31-40":0,"40+":0}};

    videoData.views = (videoData.views||0)+1;
    const userAgeGroup = userData.ageGroup || "15-24";
    if(!videoData.ageGroups) videoData.ageGroups={"15-24":0,"25-30":0,"31-40":0,"40+":0};
    videoData.ageGroups[userAgeGroup] = (videoData.ageGroups[userAgeGroup]||0)+1;

    await setDoc(videoDocRef, videoData, {merge:true});
  }
}

// Modal
const modal = document.getElementById('modal');
const closeBtn = modal.querySelector('.close-btn');
const ctx = document.getElementById('analysisChart').getContext('2d');
let chartInstance = null;

function showAnalysis(videoData){
  modal.style.display='flex';
  const labels=['المشاهدات','المهتمون','15-24','25-30','31-40','40+'];
  const data=[
    videoData.views||0,
    videoData.interestedUsers.length||0,
    videoData.ageGroups["15-24"]||0,
    videoData.ageGroups["25-30"]||0,
    videoData.ageGroups["31-40"]||0,
    videoData.ageGroups["40+"]||0
  ];
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{
    type:'bar',
    data:{labels, datasets:[{label:'عدد', data, backgroundColor:['#00e6ff','#ffeb3b','#4caf50','#f44336','#ff9800','#9c27b0']}]},
    options:{responsive:true, scales:{y:{beginAtZero:true}}}
  });
}

closeBtn.addEventListener('click',()=>{modal.style.display='none';});

// فلتر المهتم
const interestedFilter = document.getElementById('interestedFilter');
interestedFilter.addEventListener('change', ()=>{
  const videoDivs = document.querySelectorAll('.video-container');
  videoDivs.forEach(div=>{
    const checkBox = div.querySelector('.interested-checkbox');
    div.style.display = (interestedFilter.checked && !checkBox.checked)? 'none':'block';
  });
});
</script>
</body>
</html>
