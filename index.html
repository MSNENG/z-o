<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>الصفحة الرئيسية</title>
  <style>
    body { margin:0; padding-top:60px; font-family:'Tahoma',sans-serif; background:linear-gradient(-45deg,#0f2027,#203a43,#2c5364,#0f2027); background-size:400% 400%; animation:gradientMove 12s ease infinite; color:#fff; text-align:center; }
    @keyframes gradientMove {0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
    #topBar { position:fixed; top:0; left:0; width:100%; height:50px; background:rgba(0,0,0,0.7); display:flex; justify-content:flex-end; align-items:center; padding:0 20px; z-index:100; box-shadow:0 2px 10px rgba(0,0,0,0.5);}
    #userMenu { position:relative; }
    #userBtn { background:none; border:none; color:#00e6ff; cursor:pointer; font-size:1rem; }
    #userBtn:hover { text-decoration:underline; }
    #dropdown { display:none; position:absolute; right:0; top:100%; background:#111; border:1px solid #00e6ff; border-radius:5px; min-width:150px; }
    #dropdown a { display:block; padding:8px 12px; color:#00e6ff; text-decoration:none; }
    #dropdown a:hover { background:#00e6ff; color:#000; }
    .video-container { width:80%; max-width:800px; margin:20px 0; position:relative; }
    .video-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); justify-content:center; align-items:center; z-index:1000; }
    .video-overlay iframe { width:80%; height:80%; }
    .close-btn { position:absolute; top:20px; right:20px; background:#ff0; color:#000; border:none; padding:10px 15px; font-size:1rem; cursor:pointer; border-radius:5px; }
    .interested-container { margin-top:5px; display:flex; justify-content:center; align-items:center; gap:5px; }
    .chart-modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#222; padding:20px; border-radius:10px; z-index:1001; max-width:90%; max-height:90%; overflow:auto; color:#fff; }
    .chart-modal canvas { max-width:100%; }
    .chart-close { position:absolute; top:10px; left:10px; background:#ff0; border:none; padding:5px 10px; cursor:pointer; border-radius:5px; }
    .filter-btn { margin:20px; padding:10px 15px; border:none; border-radius:5px; cursor:pointer; background:#00e6ff; color:#000; }
    .filter-btn.active { background:#ff0; }
    #moneyDisplay { margin-right:20px; font-weight:bold; color:#ff0; }
  </style>
</head>
<body>
  <div id="topBar">
    <span id="moneyDisplay">$ 0 SR</span>
    <div id="userMenu">
      <button id="userBtn">اسم المستخدم ▼</button>
      <div id="dropdown">
        <a href="user-info.html">معلومات المستخدم</a>
        <a href="#" id="logoutLink">تسجيل الخروج</a>
      </div>
    </div>
  </div>

  <h1 id="welcome">مرحبا بك</h1>

  <button class="filter-btn" id="filterInterested">عرض الفيديوهات المهتم بها</button>

  <div id="videosContainer"></div>

  <div class="video-overlay" id="videoOverlay">
    <button class="close-btn" id="closeVideo">إغلاق الفيديو</button>
    <iframe id="overlayPlayer" src="" frameborder="0" allowfullscreen></iframe>
  </div>

  <div class="chart-modal" id="chartModal">
    <button class="chart-close" id="closeChart">إغلاق التحليل</button>
    <canvas id="chartCanvas"></canvas>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDUW9M48CLaSNKbs-zrpuVl2Tu9EOqLUlA",
      authDomain: "new-z-o.firebaseapp.com",
      projectId: "new-z-o",
      storageBucket: "new-z-o.firebasestorage.app",
      messagingSenderId: "692467470055",
      appId: "1:692467470055:web:3b4f4130b09f2044de9c42",
      measurementId: "G-M8KNYMSY3T"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const welcome = document.getElementById('welcome');
    const userBtn = document.getElementById('userBtn');
    const dropdown = document.getElementById('dropdown');
    const logoutLink = document.getElementById('logoutLink');
    const moneyDisplay = document.getElementById('moneyDisplay');

    let currentUser = null;
    let videosData = [];

    onAuthStateChanged(auth, async (user) => {
      if(!user) window.location.href = 'login.html';
      else {
        currentUser = user;
        const displayName = user.displayName || user.email;
        welcome.textContent = `مرحبا بك، ${displayName}!`;
        userBtn.textContent = displayName + ' ▼';

        // جلب مبلغ المستخدم
        const userDoc = await getDoc(doc(db,'users',user.uid));
        if(userDoc.exists()) moneyDisplay.textContent = `$ ${userDoc.data().money || 0} SR`;

        loadVideos();
      }
    });

    userBtn.addEventListener('click',()=>{dropdown.style.display = dropdown.style.display==='block'?'none':'block';});
    logoutLink.addEventListener('click', async()=>{await signOut(auth); window.location.href='login.html';});

    const videosContainer = document.getElementById('videosContainer');
    const videoOverlay = document.getElementById('videoOverlay');
    const overlayPlayer = document.getElementById('overlayPlayer');
    const closeVideo = document.getElementById('closeVideo');
    const filterInterestedBtn = document.getElementById('filterInterested');

    closeVideo.addEventListener('click',()=>{overlayPlayer.src=''; videoOverlay.style.display='none';});

    filterInterestedBtn.addEventListener('click',()=>{
      filterInterestedBtn.classList.toggle('active');
      displayVideos(videosData);
    });

    async function loadVideos(){
      const snapshot = await getDocs(collection(db,'videos'));
      videosData = [];
      snapshot.forEach(docSnap=>{
        const data = docSnap.data();
        data.id = docSnap.id;
        videosData.push(data);
      });
      displayVideos(videosData);
    }

    function displayVideos(videos){
      videosContainer.innerHTML='';
      videos.forEach(video=>{
        if(filterInterestedBtn.classList.contains('active') && !(video.interestedUsers || []).includes(currentUser.uid)) return;
        // تحقق من المنطقة
        if(video.region && video.region!=='الكل'){
          getDoc(doc(db,'users',currentUser.uid)).then(uDoc=>{
            if(uDoc.exists() && uDoc.data().region!==video.region) return;
          });
        }

        const div = document.createElement('div');
        div.classList.add('video-container');

        const playBtn = document.createElement('button');
        playBtn.textContent='▶ عرض الفيديو';
        playBtn.addEventListener('click',()=>{
          overlayPlayer.src=`https://www.youtube.com/embed/${video.videoId}?autoplay=1`;
          videoOverlay.style.display='flex';
        });

        const interestedDiv = document.createElement('div');
        interestedDiv.classList.add('interested-container');
        const interestedLabel = document.createElement('span');
        interestedLabel.textContent='مهتم';
        const interestedCheckbox = document.createElement('input');
        interestedCheckbox.type='checkbox';
        interestedCheckbox.checked = video.interestedUsers?.includes(currentUser.uid)||false;
        interestedCheckbox.addEventListener('change', async()=>{
          const idx = video.interestedUsers?.indexOf(currentUser.uid)||-1;
          if(interestedCheckbox.checked){
            if(idx===-1){
              if(!video.interestedUsers) video.interestedUsers=[];
              video.interestedUsers.push(currentUser.uid);
            }
          } else {
            if(idx>-1) video.interestedUsers.splice(idx,1);
          }
          await setDoc(doc(db,'videos',video.id),video,{merge:true});
        });
        interestedDiv.appendChild(interestedLabel);
        interestedDiv.appendChild(interestedCheckbox);

        const analysisBtn = document.createElement('button');
        analysisBtn.textContent='عرض التحليل';
        analysisBtn.addEventListener('click',()=>{showChart(video)});

        div.appendChild(playBtn);
        div.appendChild(interestedDiv);
        div.appendChild(analysisBtn);

        videosContainer.appendChild(div);
      });
    }

    const chartModal = document.getElementById('chartModal');
    const chartCanvas = document.getElementById('chartCanvas');
    const closeChart = document.getElementById('closeChart');
    closeChart.addEventListener('click',()=>{chartModal.style.display='none';});

    async function showChart(video){
      chartModal.style.display='block';
      const usersSnapshot = await getDocs(collection(db,'users'));
      const ageGroups = ['15-24','25-30','31-40','40+'];
      const ageData = [0,0,0,0];
      let totalViews = video.views || 0;
      let totalInterested = video.interestedUsers?.length || 0;

      usersSnapshot.forEach(u=>{
        if(video.interestedUsers?.includes(u.id)){
          const ageGroup = u.data().ageGroup;
          const idx = ageGroups.indexOf(ageGroup);
          if(idx>-1) ageData[idx]++;
        }
      });

      new Chart(chartCanvas,{
        type:'bar',
        data:{
          labels:['إجمالي المشاهدات','المهتمون',...ageGroups],
          datasets:[{
            label:'إحصائيات الفيديو',
            data:[totalViews,totalInterested,...ageData],
            backgroundColor:['#00e6ff','#ff0','#ff6384','#36a2eb','#ffce56','#4bc0c0']
          }]
        },
        options:{ responsive:true, plugins:{legend:{display:false}} }
      });
    }

  </script>
</body>
</html>
